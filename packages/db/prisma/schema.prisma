// Prisma schema for Prediction Club MVP

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// User & Authentication
// ============================================================================

model User {
  id                        String   @id @default(cuid())
  email                     String?  @unique
  walletAddress             String   @unique
  polymarketSafeAddress     String?  @unique
  polymarketApiKeyId        String?
  polymarketApiSecret       String?
  polymarketApiPassphrase   String?
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  // Relations
  managedClubs    Club[]         @relation("ClubManager")
  memberships     ClubMember[]
  applications    Application[]
  predictionRoundMembers   PredictionRoundMember[]
  verifications   Verification[]

  @@index([walletAddress])
  @@index([email])
}

// ============================================================================
// Club
// ============================================================================

model Club {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  description   String?

  // Manager (off-chain role)
  managerUserId String
  manager       User     @relation("ClubManager", fields: [managerUserId], references: [id])

  // Visibility
  isPublic      Boolean  @default(false)

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  members       ClubMember[]
  applications  Application[]
  predictionRounds       PredictionRound[]

  @@index([slug])
  @@index([managerUserId])
}

// ============================================================================
// Club Membership
// ============================================================================

enum MemberRole {
  MEMBER
  ADMIN
}

enum MemberStatus {
  ACTIVE
  INACTIVE
  REMOVED
}

model ClubMember {
  id        String       @id @default(cuid())
  clubId    String
  club      Club         @relation(fields: [clubId], references: [id], onDelete: Cascade)
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  role      MemberRole   @default(MEMBER)
  status    MemberStatus @default(ACTIVE)

  joinedAt  DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@unique([clubId, userId])
  @@index([clubId])
  @@index([userId])
}

// ============================================================================
// Application (to join a club)
// ============================================================================

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

model Application {
  id        String            @id @default(cuid())
  clubId    String
  club      Club              @relation(fields: [clubId], references: [id], onDelete: Cascade)
  userId    String
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  status    ApplicationStatus @default(PENDING)
  message   String?           // Optional message from applicant

  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@unique([clubId, userId])
  @@index([clubId, status])
  @@index([userId])
}

// ============================================================================
// Prediction Round (prediction round / trade)
// ============================================================================

enum PredictionRoundStatus {
  PENDING     // Created, not yet executed
  COMMITTED   // Orders placed
  SETTLED     // Market resolved and settled
  CANCELLED   // Cancelled before execution
}

model PredictionRound {
  id              String       @id @default(cuid())
  clubId          String
  club            Club         @relation(fields: [clubId], references: [id], onDelete: Cascade)

  // Market reference (e.g., Polymarket condition ID or URL)
  marketRef       String?
  marketTitle     String?
  polymarketConditionId  String?
  polymarketMarketUrl    String?
  polymarketOutcomeYesToken  String?
  polymarketOutcomeNoToken   String?
  polymarketResolvedAt   DateTime?
  polymarketWinningOutcome String?
  polymarketInitialYesPrice String?
  polymarketSettlementYesPrice String?

  // Aggregated stake
  stakeTotal      String       @default("0") // BigInt as string (wei)

  status          PredictionRoundStatus @default(PENDING)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  members         PredictionRoundMember[]

  @@index([clubId])
  @@index([status])
  @@index([polymarketConditionId])
}

// ============================================================================
// Prediction Round Member (individual participation in a prediction round)
// ============================================================================

model PredictionRoundMember {
  id            String   @id @default(cuid())
  predictionRoundId      String
  predictionRound        PredictionRound   @relation(fields: [predictionRoundId], references: [id], onDelete: Cascade)
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Amounts in wei as strings
  commitAmount  String   @default("0") // Amount committed
  payoutAmount  String   @default("0") // Amount received after settlement
  pnlAmount     String   @default("0") // Profit/loss (payout - commit)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([predictionRoundId, userId])
  @@index([predictionRoundId])
  @@index([userId])
}

// ============================================================================
// Verification (off-chain manager verification)
// ============================================================================

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

model Verification {
  id         String             @id @default(cuid())
  userId     String
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  status     VerificationStatus @default(PENDING)
  verifiedAt DateTime?
  notes      String?            // Admin notes

  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  @@index([userId])
  @@index([status])
}
