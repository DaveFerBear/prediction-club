// Prisma schema for Prediction Club MVP

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// User & Authentication
// ============================================================================

model User {
  id                        String   @id @default(cuid())
  email                     String?  @unique
  walletAddress             String   @unique
  turnkeySubOrgId           String?  @unique
  turnkeyEndUserId          String?
  primaryWithdrawalAddress  String?
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  // Relations
  memberships     ClubMember[]
  applications    Application[]
  predictionRoundMembers   PredictionRoundMember[]
  ledgerEntries           LedgerEntry[]
  clubWallets             ClubWallet[]
  verifications   Verification[]
  createdClubs    Club[]            @relation("ClubCreatedBy")
  createdPredictionRounds PredictionRound[] @relation("PredictionRoundCreatedBy")

  @@index([walletAddress])
  @@index([email])
}

// ============================================================================
// Club
// ============================================================================

model Club {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  description   String?
  createdByUserId String?
  createdBy     User?    @relation("ClubCreatedBy", fields: [createdByUserId], references: [id])

  // Visibility
  isPublic      Boolean  @default(false)

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  members       ClubMember[]
  applications  Application[]
  clubWallets   ClubWallet[]
  predictionRounds       PredictionRound[]
  ledgerEntries          LedgerEntry[]

  @@index([slug])
  @@index([createdByUserId])
}

// ============================================================================
// Club Membership
// ============================================================================

enum MemberRole {
  MEMBER
  ADMIN
}

enum MemberStatus {
  ACTIVE
  INACTIVE
  REMOVED
}

model ClubMember {
  id        String       @id @default(cuid())
  clubId    String
  club      Club         @relation(fields: [clubId], references: [id], onDelete: Cascade)
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  role      MemberRole   @default(MEMBER)
  status    MemberStatus @default(ACTIVE)

  joinedAt  DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@unique([clubId, userId])
  @@index([clubId])
  @@index([userId])
}

model ClubWallet {
  id                      String           @id @default(cuid())
  userId                  String
  user                    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  clubId                  String
  club                    Club             @relation(fields: [clubId], references: [id], onDelete: Cascade)
  turnkeyWalletAddress    String           @unique
  turnkeyWalletAccountId  String
  turnkeyDelegatedUserId  String
  turnkeyPolicyId         String
  polymarketSafeAddress   String?          @unique
  polymarketApiKeyId      String?
  polymarketApiSecret     String?
  polymarketApiPassphrase String?
  // App-level provisioning state for our orchestration flow (Turnkey signer + Safe + approvals + CLOB creds).
  // This is not a native Turnkey field and not an on-chain Safe contract field.
  provisioningStatus      ClubWalletProvisioningStatus @default(PENDING)
  provisioningError       String?
  provisionedAt           DateTime?
  lastProvisioningAttemptAt DateTime?
  isDisabled              Boolean          @default(false)
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt

  ledgerEntries           LedgerEntry[]

  @@unique([userId, clubId])
  @@index([clubId, isDisabled])
  @@index([provisioningStatus])
  @@index([polymarketSafeAddress])
  @@index([turnkeyWalletAddress])
}

enum ClubWalletProvisioningStatus {
  PENDING
  PROVISIONING
  READY
  FAILED
}

// ============================================================================
// Application (to join a club)
// ============================================================================

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

model Application {
  id        String            @id @default(cuid())
  clubId    String
  club      Club              @relation(fields: [clubId], references: [id], onDelete: Cascade)
  userId    String
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  status    ApplicationStatus @default(PENDING)
  message   String?           // Optional message from applicant

  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@unique([clubId, userId])
  @@index([clubId, status])
  @@index([userId])
}

// ============================================================================
// Prediction Round (prediction round / trade)
// ============================================================================

enum PredictionRoundStatus {
  PENDING     // Created, not yet executed
  COMMITTED   // Orders placed
  SETTLED     // Market resolved and settled
  CANCELLED   // Cancelled before execution
}

enum LedgerEntryType {
  DEPOSIT
  COMMIT
  PAYOUT
  WITHDRAW
  ADJUSTMENT
}

model PredictionRound {
  id              String       @id @default(cuid())
  clubId          String
  club            Club         @relation(fields: [clubId], references: [id], onDelete: Cascade)
  createdByUserId String?
  createdBy       User?        @relation("PredictionRoundCreatedBy", fields: [createdByUserId], references: [id])

  // Market identity
  conditionId     String
  marketId        String
  marketSlug      String
  marketTitle     String?
  // Optional markdown commentary from humans or agents.
  commentary      String?

  // Aggregated stake
  stakeTotal      String       @default("0") // BigInt as string (wei)

  status          PredictionRoundStatus @default(PENDING)
  targetOutcome   String
  targetTokenId   String

  // Resolution metadata: null at creation, set when chainworker resolves the market.
  outcome         String? // Resolved market outcome label.
  resolvedAt      DateTime? // Timestamp reported by market resolution.

  // Settlement metadata: null at creation, set when chainworker finalizes payouts.
  settledAt       DateTime? // Timestamp when round settlement finished.

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  members         PredictionRoundMember[]
  ledgerEntries   LedgerEntry[]

  @@index([clubId])
  @@index([status])
  @@index([conditionId])
  @@index([targetTokenId])
  @@index([createdByUserId])
}

// ============================================================================
// Prediction Round Member (individual participation in a prediction round)
// ============================================================================

model PredictionRoundMember {
  id            String   @id @default(cuid())
  predictionRoundId      String
  predictionRound        PredictionRound   @relation(fields: [predictionRoundId], references: [id], onDelete: Cascade)
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Amounts in wei as strings
  commitAmount  String   @default("0") // Amount committed
  payoutAmount  String   @default("0") // Amount received after settlement (updated at settlement)
  pnlAmount     String   @default("0") // Profit/loss (updated at settlement)

  // Order-placement metadata: null at creation, set when chainworker places orders.
  // Polymarket order metadata (minimal useful fields from /orders/get-order)
  orderId       String? // CLOB order identifier.
  orderStatus   String? // Latest order status from CLOB.
  orderSide     String? // Order side (BUY/SELL).
  orderPrice    String? // Order price at placement.
  orderSize     String? // Original requested order size.
  orderSizeMatched String? // Filled size recorded by CLOB.
  orderType     String? // Order execution type (e.g. FOK/FAK).
  orderOutcome  String? // Outcome label attached to the order.
  orderCreatedAt DateTime? // Timestamp when order was created.
  orderTxHashes Json? // Transaction hashes returned by CLOB.
  orderMakingAmount String? // Making amount from order response.
  orderTakingAmount String? // Taking amount from order response.

  // Settlement metadata: null at creation, set when member settlement is finalized.
  settledAt     DateTime? // Timestamp when member settlement finished.

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([predictionRoundId, userId])
  @@index([predictionRoundId])
  @@index([userId])
  @@index([orderId])
}

model LedgerEntry {
  id                 String           @id @default(cuid())
  safeAddress        String
  clubWalletId       String?
  clubWallet         ClubWallet?      @relation(fields: [clubWalletId], references: [id], onDelete: SetNull)
  clubId             String
  club               Club             @relation(fields: [clubId], references: [id], onDelete: Cascade)
  userId             String
  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  predictionRoundId  String?
  predictionRound    PredictionRound? @relation(fields: [predictionRoundId], references: [id], onDelete: SetNull)
  type               LedgerEntryType
  amount             String           // signed amount in wei as string
  asset              String
  txHash             String?          // on-chain or relayer transaction hash (when applicable)
  metadata           Json?
  createdAt          DateTime         @default(now())

  @@index([safeAddress])
  @@index([clubWalletId])
  @@index([clubId])
  @@index([userId])
  @@index([predictionRoundId])
}

// ============================================================================
// Verification (off-chain manager verification)
// ============================================================================

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

model Verification {
  id         String             @id @default(cuid())
  userId     String
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  status     VerificationStatus @default(PENDING)
  verifiedAt DateTime?
  notes      String?            // Admin notes

  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  @@index([userId])
  @@index([status])
}
