# Club Agents Scripts

This folder now uses a single config-driven runner:

- `run-agent.ts`
- `agents.json` (hard-coded agent definitions)

## Prerequisites

- Database configured (`DATABASE_URL`)
- Service owner user `predictionclubagent@gmail.com` exists in DB
- Service owner has completed Turnkey sign-in (has `turnkeySubOrgId`)
- Tap wallet private key set (`AGENT_TAP_PRIVATE_KEY`) for treasury funding

For LLM selection, install AI SDK packages in web workspace:

```bash
yarn workspace @prediction-club/web add ai @ai-sdk/openai @ai-sdk/anthropic @ai-sdk/google
```

Set at least one provider key:

- OpenAI: `OPENAI_API_KEY`
- Anthropic: `ANTHROPIC_API_KEY`
- Gemini: `GOOGLE_GENERATIVE_AI_API_KEY`

## Configure Agents

Edit:

- `apps/web/src/scripts/agents/agents.json`

Each agent defines:

- `id`, `name`, `enabled`
- `clubSlug`
- optional `clubName`, `clubDescription`, `clubIsPublic` (used if the club must be auto-created)
- `provider`, `model`, `persona`
- strategy defaults: `queryPool`, `maxMarketsPerQuery`, `temperature`, `defaultCount`, `defaultAmountUsdc`
- optional strategy filter: `maxHoursToResolution` (hard filters markets by resolution horizon before LLM selection)

Shared treasury tap policy (applies to all agents) lives in:

- `apps/web/src/scripts/agents/agent-funding-config.ts`

## Run Agent

Preview mode (no DB writes):

```bash
yarn agent:run --agent=default-agent --mode=preview
```

Commit mode (creates prediction rounds):

```bash
yarn agent:run --agent=default-agent --mode=commit
```

or directly:

```bash
npx tsx apps/web/src/scripts/agents/run-agent.ts --agent=default-agent --mode=preview
```

## Fund Agent Treasuries

Funds all enabled agent clubs to a shared target if their safe balance is below a shared minimum.

```bash
yarn agent:fund
```

or directly:

```bash
npx tsx apps/web/src/scripts/agents/fund-agent-wallets.ts
```

Current behavior:

- Reads all enabled agents from `agents.json`
- Auto-creates missing clubs by slug (same as run-agent)
- Ensures each club wallet exists and is provisioned
- Checks safe USDC.e balance
- If balance `< MIN`, transfers enough USDC.e from tap wallet to reach `TARGET`
- Records confirmed deposits via `LedgerController.recordDeposit`

## CLI Flags

- `--agent` (required): agent id from `agents.json`
- `--mode` (required): `preview` or `commit`
- `--count=<n>` (optional override): default from agent strategy
- `--amount-usdc=<decimal>` (optional override): default from agent strategy, minimum `1.00`
- `--provider=openai|anthropic|google` (optional override)
- `--model=<model-name>` (optional override)
- `--persona="<prompt text>"` (optional override)

Legacy flags are not supported:

- `--club`
- `--dry-run`

## Behavior

- If `clubSlug` does not exist, the runner creates the club first with:
  - `name`: `clubName` or agent `name`
  - `description`: `clubDescription` or default autogenerated text
  - `isPublic`: `clubIsPublic` or `false`
- Rotates through a query pool for diversity
- Fetches up to configured market cap per query
- Applies optional hard horizon filter (`maxHoursToResolution`) before LLM selection
  - For horizon-constrained agents, uses Gamma `/markets` with `end_date_min` / `end_date_max`
- Skips condition IDs used in last 7 days for the club
- Skips active condition IDs (`PENDING` / `COMMITTED`)
- Uses LLM to select one market and one valid outcome
- Validates model output strictly against candidate set
- `preview`: prints choices + rationale
- `commit`: creates `PredictionRound` entries and stores markdown commentary

## Notes

- If all iterations are skipped/failed, script exits non-zero.
- If at least one iteration succeeds, script exits zero.
- Chainworker must be running to execute and settle committed rounds.
